{% extends "base.html" %}
{% load static %}

{% block title %}Track Order #{{ order.id }} - Gadget Shop{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/amazon-style.css' %}">
{% endblock %}

{% block content %}
<div class="amazon-container">
  <!-- Breadcrumb -->
  <div class="amazon-breadcrumb">
    <a href="{% url 'shop:home' %}">Home</a> › 
    <a href="{% url 'users:profile' %}">Your Account</a> › 
    <span>Track Order</span>
  </div>

  <!-- Removed duplicate/erroneous status block above. Only the correct status timeline loop below remains. -->
        {% with status_list="PLACED,PACKED,SHIPPED,OUT_FOR_DELIVERY,DELIVERED" %}
          {% for status_item in status_list|split:"," %}
            <div class="order-status-row{% if forloop.last %} order-status-row-last{% endif %}">
              <!-- Status Dot -->
              <div class="order-status-dot {% if order.status == status_item or forloop.counter <= 'PLACED,PACKED,SHIPPED,OUT_FOR_DELIVERY,DELIVERED'|split:','|length and order.status in 'PLACED,PACKED,SHIPPED,OUT_FOR_DELIVERY,DELIVERED'|split:','|slice:forloop.counter0: %}order-status-dot-active{% endif %}">
              </div>
              
              <!-- Status Content -->
              <div>
                <div class="order-status-label {% if order.status == status_item %}order-status-label-active{% endif %}">
                  {% if status_item == 'PLACED' %}Order Placed
                  {% elif status_item == 'SHIPPED' %}Order Shipped
                  {% elif status_item == 'OUT_FOR_DELIVERY' %}Out for Delivery
                  {% elif status_item == 'DELIVERED' %}Delivered
                  {% endif %}
                </div>
                <div class="order-status-date">
                  {% if status_item == 'PLACED' %}
                    {{ order.created_at|date:"M j, Y g:i A" }}
                  {% elif status_item == 'PACKED' and order.status != 'PLACED' %}
                    {% if order.status == 'PACKED' %}{{ order.updated_at|date:"M j, Y g:i A" }}{% else %}Expected within 1-2 business days{% endif %}
                  {% elif status_item == 'SHIPPED' and order.status in 'SHIPPED,OUT_FOR_DELIVERY,DELIVERED' %}
                    {% if order.status == 'SHIPPED' %}{{ order.updated_at|date:"M j, Y g:i A" }}{% else %}Expected within 2-3 business days{% endif %}
                  {% elif status_item == 'OUT_FOR_DELIVERY' and order.status in 'OUT_FOR_DELIVERY,DELIVERED' %}
                    {% if order.status == 'OUT_FOR_DELIVERY' %}{{ order.updated_at|date:"M j, Y g:i A" }}{% else %}Expected today{% endif %}
                  {% elif status_item == 'DELIVERED' and order.status == 'DELIVERED' %}
                    {{ order.updated_at|date:"M j, Y g:i A" }}
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% endwith %}
      </div>

      <!-- Current Status Info -->
      <div class="order-status-info">
        <div class="order-status-info-title">
          Current Status: {{ order.get_status_display }}
        </div>
        {% if order.tracking_number %}
          <div class="order-status-info-tracking">
            Tracking Number: <strong>{{ order.tracking_number }}</strong>
          </div>
        {% endif %}
  <div class="order-status-info-desc">
          {% if order.status == 'PLACED' %}
            Your order has been received and is being processed.
          {% elif order.status == 'PACKED' %}
            Your order has been packed and will be shipped soon.
          {% elif order.status == 'SHIPPED' %}
            Your order is on its way! Expected delivery in 2-3 business days.
          {% elif order.status == 'OUT_FOR_DELIVERY' %}
            Your order is out for delivery and should arrive today.
          {% elif order.status == 'DELIVERED' %}
            Your order has been delivered successfully!
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Delivery Address -->
    <div class="order-address-box">
      <h3 class="order-address-title">Delivery Address</h3>
      <div class="order-address-content">
        <strong>{{ order.customer_name }}</strong><br>
        {{ order.address }}<br>
        {{ order.city }}, {{ order.state }} {{ order.postal_code }}<br>
        {{ order.country }}<br>
        {% if order.phone_number %}
        Phone: {{ order.phone_number }}
        {% endif %}
      </div>
    </div>

    <!-- Order Items -->
    <div class="order-items-box">
      <h3 class="order-items-title">Items in this Order</h3>
      {% for item in order.items.all %}
        <div class="order-item-row{% if forloop.last %} order-item-row-last{% endif %}">
          <img src="{% if item.product.image %}{{ item.product.image.url }}{% else %}https://via.placeholder.com/80x80?text=No+Image{% endif %}" 
               alt="{{ item.product.name }}"
               class="order-item-img"
               onerror="this.src='https://via.placeholder.com/80x80?text=No+Image'">
          <div class="order-item-details">
            <div class="order-item-name">{{ item.product.name }}</div>
            <div class="order-item-qty">Quantity: {{ item.quantity }}</div>
            <div class="order-item-price">Price: ₹{{ item.price|floatformat:2 }} each</div>
          </div>
          <div class="order-item-cost">₹{{ item.get_cost|floatformat:2 }}</div>
        </div>
      {% endfor %}
      
  <div class="order-total">
        Total: ₹{{ order.get_total_cost|floatformat:2 }}
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="order-action-btns">
      <a href="{% url 'users:profile' %}" class="amazon-btn amazon-btn-secondary order-btn">View All Orders</a>
      <a href="{% url 'shop:product_list' %}" class="amazon-btn amazon-btn-secondary order-btn">Continue Shopping</a>
      <a href="{% url 'shop:home' %}" class="amazon-btn amazon-btn-primary order-btn">Back to Home</a>
    </div>

    <!-- Help Section -->
    <div class="order-help-box">
      <h3 class="order-help-title">Need Help?</h3>
      <ul class="order-help-list">
        <li>Contact customer service for any delivery issues</li>
        <li>Report missing or damaged items within 7 days</li>
        <li>Track your package using the tracking number above</li>
        <li>Check delivery instructions and address details</li>
      </ul>
    </div>
  </div>
</div>

<script>

setTimeout(function() {
  if (document.visibilityState === 'visible') {
    location.reload();
  }

}, 300000);
</script>
{% endblock %}
}, 300000); // 5 minutes

// Add visual feedback for status updates
document.addEventListener('DOMContentLoaded', function() {
  const currentStatus = '{{ order.status }}';
  const statusElements = document.querySelectorAll('[data-status]');
  
  statusElements.forEach(element => {
    if (element.dataset.status === currentStatus) {
      element.style.animation = 'pulse 2s infinite';
    }
  });
});
</script>

<style>
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
</style>
{% endblock %}
