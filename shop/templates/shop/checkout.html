{% extends "base.html" %}
{% load static %}

{% block title %}Checkout{% endblock %}

{% block content %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<div class="container">
<!-- Stepper Section -->
<div class="stepper">
  <div class="stepper-step active">
    <div class="stepper-icon">
    <i class="fas fa-map-marker-alt"></i> 
    </div>
    <div class="stepper-label">Address</div>
  </div>
  <div class="stepper-step active">
    <div class="stepper-icon">
    <i class="fas fa-list"></i> 
    </div>
    <div class="stepper-label">Order Summary</div>
  </div>
  <div class="stepper-step active">
    <div class="stepper-icon">
    <i class="fas fa-credit-card"></i> 
    </div>
    <div class="stepper-label">Payment</div>
  </div>
</div>

<!-- Checkout Main Section -->
<div class="checkout-container">
  <div>
    <!-- Address Section -->
    <div class="checkout-section">
      <div class="checkout-section-title">
        <i class="fas fa-map-marker-alt"></i> Delivery Address
      </div>
      <form id="checkout-form">
        <button type="button" id="get-location-btn" class="btn btn-primary mb-4">
          <i class="fas fa-location-arrow"></i> Use My Location
        </button>
        <div class="form-group">
          <label for="name" class="form-label">Full Name</label>
          <input type="text" id="name" name="name" class="form-input" required>
        </div>
        <div class="form-group">
          <label for="address" class="form-label">Address</label>
          <textarea id="address" name="address" rows="3" class="form-input form-textarea" required></textarea>
        </div>
        <div class="form-group">
          <label for="phone" class="form-label">Phone</label>
          <input type="text" id="phone" name="phone" class="form-input" required>
        </div>
      </form>
    </div>

    <!-- Payment Section -->
    <div class="checkout-section">
      <div class="checkout-section-title">
        <i class="fas fa-credit-card"></i> Payment Method
      </div>
      <div class="mb-6">
        <div class="p-4 border-2 border-primary rounded-lg bg-primary/5" id="razorpay-option">
          <i class="fas fa-credit-card"></i> 
          <span>Razorpay / UPI / Netbanking</span>
        </div>
      </div>
      <button id="rzp-button" class="btn btn-primary btn-full">
        <i class="fas fa-lock"></i> Pay & Place Order
      </button>
    </div>
  </div>

  <!-- Order Summary Section -->
  <div class="card">
    <div class="card-header">
      <h3 class="flex items-center gap-2 font-semibold">
        <i class="fas fa-receipt"></i> Order Summary
      </h3>
    </div>
    <div class="card-body">
    <ul class="space-y-3">
      {% for item in cart_items %}
        <li class="flex justify-between items-center py-2 border-b border-light">
          <div class="flex-1">
            <div class="font-medium">{{ item.product.name }}</div>
            <div class="text-sm text-muted">Qty: {{ item.quantity }}</div>
          </div>
          <div class="font-semibold">₹{{ item.get_total_price }}</div>
        </li>
      {% endfor %}
    </ul>
    </div>
    <div class="card-footer">
      <div class="flex justify-between items-center text-xl font-bold">
        <span>Total:</span> 
        <span class="text-error">₹{{ total_price }}</span>
      </div>
    </div>
  </div>
</div>
</div>

<script>
  // Helper: set button loading state
  function setLoading(btn, isLoading, loadingText = 'Processing...') {
    if (isLoading) {
      btn.classList.add('btn-loading');
    } else {
      btn.classList.remove('btn-loading');
    }
  }

  // Live location autofill for address
  document.getElementById('get-location-btn').onclick = async function(e) {
    e.preventDefault();
    const btn = this;
    setLoading(btn, true, 'Getting location...');

    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser.');
      setLoading(btn, false);
      return;
    }

    navigator.geolocation.getCurrentPosition(async (position) => {
      try {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const res = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`,
          { headers: { 'User-Agent': 'gadget-shop' } }
        );
        const data = await res.json();
        const addr = data.address;
        const addressStr = [addr.road, addr.suburb, addr.city || addr.town || addr.village, addr.state, addr.postcode, addr.country]
          .filter(Boolean).join(', ');
        document.getElementById('address').value = addressStr;
        btn.innerHTML = '<i class="fas fa-check"></i> Location Found';
        btn.classList.add('btn-success');
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-location-arrow"></i> Use My Location';
          btn.classList.remove('btn-success');
          setLoading(btn, false);
        }, 2000);
      } catch {
        alert('Could not fetch address from location.');
        setLoading(btn, false);
      }
    }, () => {
      alert('Unable to retrieve your location.');
      setLoading(btn, false);
    });
  };

  // Validate checkout form
  function validateCheckoutForm() {
    const name = document.getElementById('name').value.trim();
    const address = document.getElementById('address').value.trim();
    const phone = document.getElementById('phone').value.trim();
    
    if (!name || !address || !phone) {
      alert('Please fill in all address fields.');
      return false;
    }
    if (!/^\d{10}$/.test(phone)) {
      alert('Please enter a valid 10-digit phone number.');
      return false;
    }
    return true;
  }

  // Razorpay Payment
  document.getElementById('rzp-button').onclick = async function(e) {
    e.preventDefault();
    const btn = this;

    if (!validateCheckoutForm()) return;
    setLoading(btn, true);

    try {
      const res = await fetch("{% url 'shop:checkout' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          name: document.getElementById("name").value,
          address: document.getElementById("address").value,
          phone: document.getElementById("phone").value,
          payment_method: "razorpay"
        })
      });

      const data = await res.json();

      if (data.razorpay_order_id && data.razorpay_key && data.razorpay_amount) {
        const options = {
          key: data.razorpay_key,
          amount: data.razorpay_amount,
          currency: "INR",
          name: "Gadget Ecommerce",
          description: "Order Payment",
          order_id: data.razorpay_order_id,
          handler: async function (response) {
            const confirmRes = await fetch("{% url 'shop:payment_success' %}", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
              },
              body: JSON.stringify({
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                name: document.getElementById("name").value,
                address: document.getElementById("address").value,
                phone: document.getElementById("phone").value
              })
            });
            const confirmData = await confirmRes.json();
            if (confirmData.status === "success") {
              window.location.href = "{% url 'shop:orders' %}";
            } else {
              alert("Payment failed! Please try again.");
              setLoading(btn, false);
            }
          },
          theme: { color: "#0d6efd" }
        };
        const rzp1 = new Razorpay(options);
        rzp1.open();
      } else {
        alert("Could not initiate payment. Please try again.");
        setLoading(btn, false);
      }
    } catch (error) {
      console.error(error);
      alert("Network error. Please try again.");
      setLoading(btn, false);
    }
  };

  // Add form animations
  document.addEventListener('DOMContentLoaded', function() {
    // Animate checkout sections
    document.querySelectorAll('.checkout-section').forEach((section, index) => {
      section.style.opacity = '0';
      section.style.transform = 'translateY(20px)';
      setTimeout(() => {
        section.style.transition = 'all 0.3s ease-out';
        section.style.opacity = '1';
        section.style.transform = 'translateY(0)';
      }, index * 200);
    });

    // Form input focus effects
    document.querySelectorAll('.form-input').forEach(input => {
      input.addEventListener('focus', function() {
        this.parentElement.classList.add('focused');
      });
      
      input.addEventListener('blur', function() {
        this.parentElement.classList.remove('focused');
      });
    });
  });
</script>
{% endblock %}
