{% extends "base.html" %}
{% load static %}
{% block title %}Checkout{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="{% static 'css/amazon-style.css' %}">
{% endblock %}
{% block content %}

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>


<!-- Stepper Section -->
<div class="amazon-stepper">
    <div class="amazon-step active"><i class="fa fa-map-marker-alt"></i> Address</div>
    <div class="amazon-step active"><i class="fa fa-list"></i> Order Summary</div>
    <div class="amazon-step active"><i class="fa fa-credit-card"></i> Payment</div>
</div>

<!-- Checkout Main Section -->
<div class="amazon-checkout-container">
    <div class="amazon-checkout-main">
        <!-- Address Section -->
        <div class="amazon-checkout-section">
            <div class="amazon-section-title"><i class="fa fa-map-marker-alt"></i> Delivery Address</div>
            <form id="checkout-form">
                <button type="button" id="get-location-btn" class="amazon-btn amazon-btn-primary amazon-location-btn"><i class="fa fa-location-arrow"></i> Use My Location</button>
                <div class="amazon-form-group">
                    <label for="name" class="amazon-form-label">Full Name</label>
                    <input type="text" id="name" name="name" class="amazon-form-input" required>
                </div>
                <div class="amazon-form-group">
                    <label for="address" class="amazon-form-label">Address</label>
                    <textarea id="address" name="address" rows="3" class="amazon-form-input" required></textarea>
                </div>
                <div class="amazon-form-group">
                    <label for="phone" class="amazon-form-label">Phone</label>
                    <input type="text" id="phone" name="phone" class="amazon-form-input" required>
                </div>
            </form>
        </div>
        <!-- Payment Section -->
        <div class="amazon-checkout-section">
            <div class="amazon-section-title"><i class="fa fa-credit-card"></i> Payment Method</div>
            <div class="amazon-payment-methods">
                <div class="amazon-payment-option selected" id="razorpay-option"><i class="fa fa-credit-card"></i> Razorpay / UPI / Netbanking</div>
            </div>
            <button id="rzp-button" class="amazon-btn amazon-btn-primary amazon-place-order-btn">Pay & Place Order</button>
        </div>
    </div>
    <!-- Order Summary Section -->
    <div class="amazon-order-summary">
        <h3>Order Summary</h3>
        <ul class="amazon-summary-list">
            {# Ensure only <li> as direct children #}
            {% for item in cart_items %}
                <li class="amazon-summary-row">
                    <span>{{ item.product.name }} x {{ item.quantity }}</span>
                    <span>₹{{ item.get_total_price }}</span>
                </li>
            {% endfor %}
        </ul>
        <div class="amazon-summary-total">
            <span>Total:</span> <span>₹{{ total_price }}</span>
        </div>
    </div>
</div>

<script>

    // Live location autofill for address
    document.getElementById('get-location-btn').onclick = function(e) {
        e.preventDefault();
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser.');
            return;
        }
        document.getElementById('get-location-btn').textContent = 'Getting location...';
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;
            // Use OpenStreetMap Nominatim for reverse geocoding
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`, {
                headers: { 'User-Agent': 'gadget-shop' }
            })
            .then(res => res.json())
            .then(data => {
                var addr = data.address;
                var addressStr = [addr.road, addr.suburb, addr.city || addr.town || addr.village, addr.state, addr.postcode, addr.country].filter(Boolean).join(', ');
                document.getElementById('address').value = addressStr;
                document.getElementById('get-location-btn').textContent = 'Use My Location';
            })
            .catch(() => {
                alert('Could not fetch address from location.');
                document.getElementById('get-location-btn').textContent = 'Use My Location';
            });
        }, function() {
            alert('Unable to retrieve your location.');
            document.getElementById('get-location-btn').textContent = 'Use My Location';
        });
    };
    // Payment method selection


    function validateCheckoutForm() {
        var name = document.getElementById('name').value.trim();
        var address = document.getElementById('address').value.trim();
        var phone = document.getElementById('phone').value.trim();
        if (!name || !address || !phone) {
            alert('Please fill in all address fields.');
            return false;
        }
        if (!/^\d{10}$/.test(phone)) {
            alert('Please enter a valid 10-digit phone number.');
            return false;
        }
        return true;
    }

    document.getElementById('rzp-button').onclick = function(e){
        e.preventDefault();
        if (!validateCheckoutForm()) return;
        // Only online payment allowed
        fetch("{% url 'shop:checkout' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                name: document.getElementById("name").value,
                address: document.getElementById("address").value,
                phone: document.getElementById("phone").value,
                payment_method: "razorpay"
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.razorpay_order_id && data.razorpay_key && data.razorpay_amount) {
                var options = {
                    "key": data.razorpay_key,
                    "amount": data.razorpay_amount,
                    "currency": "INR",
                    "name": "Gadget Ecommerce",
                    "description": "Order Payment",
                    "order_id": data.razorpay_order_id,
                    "handler": function (response){
                        fetch("{% url 'shop:payment_success' %}", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": "{{ csrf_token }}"
                            },
                            body: JSON.stringify({
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_signature: response.razorpay_signature,
                                name: document.getElementById("name").value,
                                address: document.getElementById("address").value,
                                phone: document.getElementById("phone").value
                            })
                        }).then(res => res.json())
                          .then(data => {
                              if(data.status === "success"){
                                  window.location.href = "{% url 'shop:orders' %}";
                              } else {
                                  alert("Payment failed! Please try again.");
                              }
                          });
                    },
                    "theme": { "color": "#0d6efd" }
                };
                var rzp1 = new Razorpay(options);
                rzp1.open();
            } else {
                alert('Could not initiate payment. Please try again.');
            }
        });
    }
</script>

{% endblock %}
