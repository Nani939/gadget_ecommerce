{% extends "base.html" %}
{% load static %}

{% block title %}Checkout - Gadget Shop{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/amazon-style.css' %}">
{% endblock %}

{% block content %}
<div class="amazon-container">
  <!-- Breadcrumb -->
  <div class="amazon-breadcrumb">
    <a href="{% url 'shop:home' %}">Home</a> › 
    <a href="{% url 'shop:view_cart' %}">Cart</a> › 
    <span>Checkout</span>
  </div>

  <!-- Checkout Header -->
  <div style="text-align: center; margin-bottom: 30px;">
    <h1 style="font-size: 28px; font-weight: 400; color: var(--amazon-text); margin-bottom: 8px;">
      Checkout
    </h1>
    <div style="font-size: 14px; color: #565959;">
      Review your order and complete your purchase
    </div>
  </div>

  {% if error %}
    <div class="amazon-alert amazon-alert-error">
      <i class="bi bi-exclamation-triangle-fill"></i>
      {{ error }}
    </div>
  {% endif %}

  <div class="amazon-checkout-container">
    <!-- Main Checkout Form -->
    <div class="amazon-checkout-main">
      <form method="post" id="checkout-form">
        {% csrf_token %}
        
        <!-- Delivery Address Section -->
        <div class="amazon-checkout-section">
          <h2 class="amazon-section-title">
            <span style="background: var(--amazon-orange); color: var(--amazon-blue); border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; margin-right: 12px;">1</span>
            Delivery address
          </h2>
          
          <div style="margin-left: 36px;">
            <div class="amazon-form-group">
              <label class="amazon-form-label" for="id_address">Street Address *</label>
              <input type="text" 
                     name="address" 
                     id="id_address"
                     class="amazon-form-input" 
                     placeholder="Enter your street address"
                     value="{{ address|default:'' }}" 
                     required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div class="amazon-form-group">
                <label class="amazon-form-label" for="id_city">City *</label>
                <input type="text" 
                       name="city" 
                       id="id_city"
                       class="amazon-form-input" 
                       placeholder="Enter your city"
                       value="{{ city|default:'' }}" 
                       required>
              </div>

              <div class="amazon-form-group">
                <label class="amazon-form-label" for="id_postal_code">Postal Code *</label>
                <input type="text" 
                       name="postal_code" 
                       id="id_postal_code"
                       class="amazon-form-input" 
                       placeholder="Enter postal code"
                       value="{{ postal_code|default:'' }}" 
                       required>
              </div>
            </div>

            <div style="background: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 4px; padding: 12px; margin-top: 12px;">
              <div style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #004085;">
                <i class="bi bi-geo-alt-fill"></i>
                <span id="location-status">Detecting your location for faster delivery...</span>
              </div>
            </div>

            <input type="hidden" id="id_latitude" name="latitude" value="{{ latitude|default:'' }}">
            <input type="hidden" id="id_longitude" name="longitude" value="{{ longitude|default:'' }}">
          </div>
        </div>

        <!-- Payment Method Section -->
        <div class="amazon-checkout-section">
          <h2 class="amazon-section-title">
            <span style="background: var(--amazon-orange); color: var(--amazon-blue); border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; margin-right: 12px;">2</span>
            Payment method
          </h2>
          
          <div style="margin-left: 36px;">
            <div style="border: 1px solid var(--amazon-border); border-radius: 8px; padding: 16px;">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="payment_method" value="cod" checked style="margin-right: 12px;">
                <div>
                  <div style="font-weight: 700; margin-bottom: 4px;">Cash on Delivery</div>
                  <div style="font-size: 14px; color: #565959;">Pay when your order is delivered</div>
                </div>
              </label>
            </div>
            
            <div style="border: 1px solid var(--amazon-border); border-radius: 8px; padding: 16px; margin-top: 8px; opacity: 0.6;">
              <label style="display: flex; align-items: center; cursor: not-allowed;">
                <input type="radio" name="payment_method" value="card" disabled style="margin-right: 12px;">
                <div>
                  <div style="font-weight: 700; margin-bottom: 4px;">Credit/Debit Card</div>
                  <div style="font-size: 14px; color: #565959;">Coming soon</div>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- Review Items Section -->
        <div class="amazon-checkout-section">
          <h2 class="amazon-section-title">
            <span style="background: var(--amazon-orange); color: var(--amazon-blue); border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; margin-right: 12px;">3</span>
            Review items and delivery
          </h2>
          
          <div style="margin-left: 36px;">
            <div style="background: var(--amazon-gray); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
              <div style="font-weight: 700; margin-bottom: 8px; color: var(--amazon-success);">
                <i class="bi bi-truck"></i>
                Delivery: Tomorrow by 10 PM
              </div>
              <div style="font-size: 14px; color: #565959;">
                FREE delivery on orders over ₹499
              </div>
            </div>

            {% for item in cart_items %}
              <div style="display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid #e7e7e7;">
                <img src="{% if item.product.image %}{{ item.product.image.url }}{% else %}https://via.placeholder.com/80x80?text=No+Image{% endif %}" 
                     alt="{{ item.product.name }}"
                     style="width: 80px; height: 80px; object-fit: contain; border-radius: 4px;"
                     onerror="this.src='https://via.placeholder.com/80x80?text=No+Image'">
                
                <div style="flex: 1;">
                  <div style="font-weight: 500; margin-bottom: 4px;">{{ item.product.name }}</div>
                  <div style="font-size: 14px; color: #565959; margin-bottom: 4px;">
                    Qty: {{ item.quantity }}
                  </div>
                  <div style="font-size: 14px; color: var(--amazon-success);">
                    In Stock
                  </div>
                </div>
                
                <div style="text-align: right;">
                  <div class="amazon-price">₹{{ item.total|floatformat:2 }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- Place Order Button -->
        <div style="text-align: center; margin-top: 30px;">
          <button type="submit" class="amazon-checkout-btn" style="font-size: 16px; padding: 16px 32px; min-width: 200px;">
            Place your order
          </button>
          
          <div style="font-size: 12px; color: #565959; margin-top: 12px; max-width: 400px; margin-left: auto; margin-right: auto;">
            By placing your order, you agree to Gadget Shop's privacy notice and conditions of use.
          </div>
        </div>
      </form>
    </div>

    <!-- Order Summary Sidebar -->
    <div class="amazon-order-summary">
      <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--amazon-text);">
        Order Summary
      </h3>

      <div class="amazon-summary-row">
        <span>Items ({{ cart_items|length }}):</span>
        <span>₹{{ total_price|floatformat:2 }}</span>
      </div>

      <div class="amazon-summary-row">
        <span>Delivery:</span>
        <span style="color: var(--amazon-success);">FREE</span>
      </div>

      <div class="amazon-summary-row">
        <span>Tax:</span>
        <span>₹0.00</span>
      </div>

      <div class="amazon-summary-total">
        <span>Order Total:</span>
        <span>₹{{ total_price|floatformat:2 }}</span>
      </div>

      <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e7e7e7;">
        <div style="font-size: 14px; color: var(--amazon-success); margin-bottom: 8px;">
          <i class="bi bi-shield-check"></i>
          Your order is protected
        </div>
        <div style="font-size: 12px; color: #565959;">
          We use secure encryption to protect your payment information.
        </div>
      </div>

      <!-- Promotional Offers -->
      <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e7e7e7;">
        <h4 style="font-size: 14px; font-weight: 700; margin-bottom: 8px;">
          Special Offers
        </h4>
        <div style="font-size: 12px; color: #565959; margin-bottom: 8px;">
          <i class="bi bi-gift"></i>
          Free gift wrapping available
        </div>
        <div style="font-size: 12px; color: #565959;">
          <i class="bi bi-percent"></i>
          Save 10% on your next order
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function getLocation() {
  const locationStatus = document.getElementById("location-status");
  
  if (navigator.geolocation) {
    locationStatus.innerHTML = '<span class="amazon-loading"></span> Getting your location...';
    
    navigator.geolocation.getCurrentPosition(
      async function(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        
        document.getElementById("id_latitude").value = lat;
        document.getElementById("id_longitude").value = lon;

        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`,
            { headers: {'User-Agent': 'gadget-shop'} }
          );
          
          if (response.ok) {
            const data = await response.json();
            const address = data.address || {};
            
            // Auto-fill address fields if empty
            const addressField = document.getElementById("id_address");
            const cityField = document.getElementById("id_city");
            const postalField = document.getElementById("id_postal_code");
            
            if (!addressField.value && address.road) {
              addressField.value = [address.road, address.suburb].filter(Boolean).join(", ");
            }
            
            if (!cityField.value) {
              cityField.value = address.city || address.town || address.village || "";
            }
            
            if (!postalField.value && address.postcode) {
              postalField.value = address.postcode;
            }
            
            locationStatus.innerHTML = '<i class="bi bi-check-circle-fill" style="color: var(--amazon-success);"></i> Location detected successfully';
          } else {
            throw new Error('Geocoding failed');
          }
        } catch (error) {
          locationStatus.innerHTML = '<i class="bi bi-exclamation-triangle-fill" style="color: var(--amazon-warning);"></i> Could not detect location automatically';
          console.error("Geolocation error:", error);
        }
      }, 
      function(error) {
        locationStatus.innerHTML = '<i class="bi bi-exclamation-triangle-fill" style="color: var(--amazon-warning);"></i> Location access denied';
        console.warn("Geolocation permission denied:", error);
      },
      {
        timeout: 10000,
        enableHighAccuracy: true,
        maximumAge: 300000
      }
    );
  } else {
    locationStatus.innerHTML = '<i class="bi bi-x-circle-fill" style="color: var(--amazon-warning);"></i> Geolocation not supported';
  }
}

// Enhanced form submission
document.addEventListener('DOMContentLoaded', function() {
  getLocation();
  
  const form = document.getElementById('checkout-form');
  const submitBtn = form.querySelector('button[type="submit"]');
  
  form.addEventListener('submit', function(e) {
    // Add loading state
    const originalText = submitBtn.textContent;
    submitBtn.innerHTML = '<span class="amazon-loading"></span> Processing your order...';
    submitBtn.disabled = true;
    
    // Re-enable if there's an error (form doesn't submit)
    setTimeout(() => {
      if (submitBtn.disabled) {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }, 5000);
  });
});
</script>
{% endblock %}