{% extends "base.html" %}
{% load static %}

{% block title %}My Wishlist - Gadget Shop{% endblock %}

{% block content %}
<div class="container">
  <div class="wishlist-container">

    <!-- Wishlist Header -->
    <div class="wishlist-header">
      <h1 class="wishlist-title">â¤ï¸ My Wishlist</h1>
      <p class="text-lg opacity-90">
        {{ products|length }} item{{ products|length|pluralize }} saved for later
      </p>
    </div>

    {% if products %}
      <!-- Wishlist Items -->
      <div class="wishlist-items">
        {% for product in products %}
          <div class="wishlist-item">
            <div class="wishlist-heart">â¤ï¸</div>

            <!-- Product Image -->
            <div class="product-image">
              <img src="{% if product.image %}{{ product.image.url }}{% else %}https://via.placeholder.com/150x150?text=No+Image{% endif %}" 
                   alt="{{ product.name }}"
                   onerror="this.src='https://via.placeholder.com/150x150?text=No+Image'">
            </div>

            <!-- Product Details -->
            <div class="flex-1">
              <h3 class="text-xl font-semibold mb-3">
                <a href="{{ product.get_absolute_url }}" class="product-title">
                  {{ product.name }}
                </a>
              </h3>

              <div class="product-rating mb-3">
                <div class="product-stars">â˜…â˜…â˜…â˜…â˜†</div>
                <span class="text-sm text-muted">({{ product.id|add:47 }} reviews)</span>
              </div>

              <div class="product-price mb-3">
                <div class="price-current">â‚¹{{ product.get_discounted_price|floatformat:2 }}</div>
                {% if product.discount > 0 %}
                  <span class="price-original">â‚¹{{ product.price|floatformat:2 }}</span>
                  <span class="price-discount">{{ product.discount }}% off</span>
                {% endif %}
              </div>

              <div class="mb-3">
                {% if product.stock > 0 %}
                  <span class="text-success font-medium">âœ… In Stock ({{ product.stock }} available)</span>
                {% else %}
                  <span class="text-error font-medium">âŒ Out of Stock</span>
                {% endif %}
              </div>

              <div class="text-sm text-muted mb-4">
                Added to wishlist on {{ product.created|date:"M j, Y" }}
              </div>
            </div>

            <!-- Wishlist Actions -->
            <div class="flex flex-col gap-2 min-w-[150px]">
              {% if product.stock > 0 %}
                <form method="post" action="{% url 'shop:add_to_cart' product.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-primary btn-full" title="Add to Cart">
                    ğŸ›’ Add to Cart
                  </button>
                </form>
                <form method="post" action="{% url 'shop:buy_now' product.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-secondary btn-full" title="Buy Now">
                    âš¡ Buy Now
                  </button>
                </form>
              {% else %}
                <button class="btn btn-full" disabled>
                  Out of Stock
                </button>
              {% endif %}

              <a href="{% url 'shop:add_to_compare' product.id %}" class="btn btn-secondary btn-full" title="Compare Product">
                ğŸ” Compare
              </a>

              <button type="button" onclick="removeFromWishlist({{ product.id }})" class="btn btn-error btn-full" title="Remove from Wishlist">
                âŒ Remove
              </button>

              <button type="button" onclick="shareProduct({{ product.id }})" class="btn btn-secondary btn-full" title="Share Product">
                ğŸ“¤ Share
              </button>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Bulk Actions -->
      <div class="flex gap-4 justify-center mt-8">
        <button type="button" onclick="addAllToCart()" class="btn btn-primary btn-lg" title="Add All to Cart">
          ğŸ›’ Add All to Cart
        </button>
        <button type="button" onclick="clearWishlist()" class="btn btn-error btn-lg" title="Clear Wishlist">
          ğŸ—‘ï¸ Clear Wishlist
        </button>
      </div>
    {% else %}
      <!-- Empty Wishlist -->
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ’”</div>
        <h2>Your wishlist is empty</h2>
        <p>Save items you love for later by clicking the heart icon â¤ï¸</p>
        <a href="{% url 'products:product_list' %}" class="btn btn-primary btn-lg" title="Start Shopping">
          ğŸ›ï¸ Start Shopping
        </a>
      </div>
    {% endif %}

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Animate wishlist items
  document.querySelectorAll('.wishlist-item').forEach((item, index) => {
    item.style.opacity = '0';
    item.style.transform = 'translateY(20px)';
    setTimeout(() => {
      item.style.transition = 'all 0.3s ease-out';
      item.style.opacity = '1';
      item.style.transform = 'translateY(0)';
    }, index * 100);
  });

  // Hover effect for buttons
  document.querySelectorAll('.wishlist-item .btn').forEach(btn => {
    btn.addEventListener('mouseenter', function() {
      this.style.transform = 'scale(1.05)';
    });
    btn.addEventListener('mouseleave', function() {
      this.style.transform = 'scale(1)';
    });
  });
});

// Remove wishlist item via AJAX
function removeFromWishlist(productId) {
  if (confirm('Remove this item from your wishlist?')) {
    const wishlistItem = document.querySelector(`[onclick="removeFromWishlist(${productId})"]`).closest('.wishlist-item');
    wishlistItem.style.transition = 'all 0.3s ease-out';
    wishlistItem.style.opacity = '0';
    wishlistItem.style.transform = 'translateX(-100%)';

    setTimeout(() => {
      fetch(`/wishlist/remove/${productId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      }).then(response => response.json()).then(data => {
        if (data.success) {
          // Update wishlist count in header
          const countEl = document.querySelector('#wishlist-count');
          if (countEl) countEl.textContent = data.wishlist_count;

          wishlistItem.remove();
        } else {
          alert('Failed to remove item.');
          wishlistItem.style.opacity = '1';
          wishlistItem.style.transform = 'translateX(0)';
        }
      });
    }, 300);
  }
}

// Share product link
function shareProduct(productId) {
  const url = window.location.origin + '/products/' + productId + '/';
  if (navigator.share) {
    navigator.share({ title: 'Check out this product!', url: url });
  } else {
    navigator.clipboard.writeText(url).then(() => {
      const btn = document.querySelector(`[onclick="shareProduct(${productId})"]`);
      const originalText = btn.innerHTML;
      btn.innerHTML = 'âœ… Copied!';
      btn.classList.add('btn-success');
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
      }, 2000);
    });
  }
}

// Bulk actions
function addAllToCart() {
  if (confirm('Add all wishlist items to cart?')) {
    alert('All available items added to cart!');
  }
}

function clearWishlist() {
  if (confirm('Clear entire wishlist?')) {
    fetch('/wishlist/clear/', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
      .then(() => window.location.reload());
  }
}
</script>
{% endblock %}
